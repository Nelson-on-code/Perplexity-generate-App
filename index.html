<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADHD Focus Helper Pro Max</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4a90e2;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .container { max-width: 800px; margin: 0 auto; }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p { font-size: 1.1em; opacity: 0.9; }

        .level-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 0.9em;
        }

        .nav-scroll {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 998;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .nav-scroll.hidden-nav {
            display: none;
        }

        .nav-scroll-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            -webkit-user-select: none;
            user-select: none;
        }

        .nav-scroll-btn:active {
            transform: scale(0.95);
        }

        .nav-scroll-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .nav-scroll-label {
            position: absolute;
            right: 50px;
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            display: none;
            z-index: 999;
        }

        .nav-scroll-btn:hover .nav-scroll-label {
            display: block;
        }

        .section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            color: var(--dark);
            margin-top: 20px;
            margin-bottom: 15px;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin: 10px 10px 10px 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(74,144,226,0.4); }
        .btn:active { transform: translateY(0px); }
        .btn-success { background: var(--success); }
        .btn-success:hover { box-shadow: 0 5px 15px rgba(46,204,113,0.4); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { box-shadow: 0 5px 15px rgba(231,76,60,0.4); }
        .btn-small { padding: 8px 16px; font-size: 0.9em; }

        .question-group {
            background: #f8f9fa;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .question-group label {
            display: block;
            margin: 10px 0;
            font-weight: 500;
        }

        .tip {
            background: linear-gradient(135deg, #fff3cd 0%, #fff8e1 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
            display: flex;
            gap: 10px;
        }

        .tip i { color: var(--warning); font-size: 1.3em; flex-shrink: 0; }

        .score-card {
            background: linear-gradient(135deg, var(--primary) 0%, #357abd 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .score-card .number {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .score-card .level {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .task-list { list-style: none; }

        .task-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 12px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
        }

        .task-item.completed {
            background: #d4edda;
            opacity: 0.7;
            border-left-color: var(--success);
        }

        .task-item.completed span { text-decoration: line-through; }
        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        #timer {
            text-align: center;
            font-size: 5em;
            font-weight: bold;
            color: var(--primary);
            margin: 30px 0;
            font-family: 'Courier New', monospace;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .timer-display { text-align: center; }

        #progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .progress-summary {
            background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .progress-summary .percentage {
            font-size: 2em;
            color: var(--success);
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        input[type="text"],
        input[type="email"] {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card .label {
            color: var(--dark);
            margin-top: 5px;
            font-size: 0.9em;
        }

        .mindfulness-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .breath-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
        }

        .breath-circle:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        @keyframes breathPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            50% { transform: scale(1.15); box-shadow: 0 0 0 10px rgba(255,255,255,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }

        .breath-circle.breathing {
            animation: breathPulse 4s infinite;
        }

        @keyframes confetti {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), 600px) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti 3s ease-in forwards;
        }

        .hidden { display: none; }

        .success-message {
            background: #d4edda;
            border-left: 4px solid var(--success);
            padding: 15px;
            border-radius: 8px;
            color: #155724;
            margin: 15px 0;
        }

        .energy-indicator {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .energy-bar {
            flex: 1;
            height: 10px;
            border-radius: 5px;
            background: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .energy-bar.active {
            background: linear-gradient(to right, #2ecc71, #f39c12);
            box-shadow: 0 0 10px rgba(46,204,113,0.4);
        }

        .routine-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .routine-box:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .emotion-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 6px;
            border-left: 3px solid var(--warning);
        }

        @media (max-width: 600px) {
            header h1 { font-size: 1.8em; }
            #timer { font-size: 3em; }
            .section { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> ADHD Focus Helper Pro Max</h1>
            <p>åŸºæ–¼CBTçš„ç„¦é»è¨“ç·´ â€¢ ç¿’æ…£é¤Šæˆ â€¢ é€²åº¦è¿½è¹¤</p>
            <div class="level-badge"><i class="fas fa-gamepad"></i> <span id="levelDisplay">Lv.1</span> | <span id="xpDisplay">0 XP</span></div>
        </header>

        <!-- Quiz Section -->
        <div id="quiz" class="section">
            <h2><i class="fas fa-clipboard-list"></i> ADHD å¿«é€Ÿè©•ä¼°</h2>
            <p style="margin-bottom: 20px;">å›ç­”10å€‹å•é¡Œ (1=å¾ä¸, 5=ç¸½æ˜¯)ï¼Œç­è§£ä½ çš„å°ˆæ³¨åŠ›ç‹€æ…‹</p>
            <div id="questions"></div>
            <button class="btn" id="startQuizBtn" onclick="startQuiz(); event.preventDefault(); return false;"><i class="fas fa-play"></i> é–‹å§‹è©•ä¼°</button>
            <button class="btn btn-success hidden" id="submitQuiz" onclick="generatePlan(); event.preventDefault(); return false;"><i class="fas fa-check"></i> ç”Ÿæˆå€‹äººè¨ˆåŠƒ</button>
        </div>

        <!-- Plan Section -->
        <div id="plan" class="section hidden">
            <h2><i class="fas fa-target"></i> ä½ çš„å€‹äººç„¦é»è¨ˆåŠƒ</h2>
            
            <div class="score-card">
                <div>ADHDå‚¾å‘è©•åˆ†</div>
                <div class="number" id="score">--</div>
                <div class="level" id="level">è©•ä¼°ä¸­...</div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <h3 style="margin: 0;"><i class="fas fa-lightbulb"></i> ä»Šæ—¥ç·´ç¿’é‡é»</h3>
                <button class="btn btn-success" onclick="retakeQuiz()" style="margin: 0;"><i class="fas fa-redo"></i> é‡æ–°æ¸¬é©—</button>
            </div>
            <div id="dailyTips"></div>

            <!-- Energy Level & Task Difficulty -->
            <h3 id="energySection"><i class="fas fa-battery-three-quarters"></i> è‡ªæˆ‘æª¢æ¸¬ç•¶å‰ç²¾åŠ›æ°´å¹³</h3>
            <div class="energy-indicator" id="energyLevel"></div>
            <p style="color: #666; font-size: 0.9em; margin-top: 10px;">æ ¹æ“šä½ çš„ç²¾åŠ›æ°´å¹³ï¼Œæ¨è–¦ä»¥ä¸‹ä»»å‹™é›£åº¦ï¼š</p>
            <div id="taskRecommendation" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;"></div>

            <!-- Morning & Evening Routines -->
            <h3 id="routineSection"><i class="fas fa-calendar-check"></i> æ¨è–¦ä¾‹è¡Œç¨‹åº</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px;">
                    <h4><i class="fas fa-sunrise"></i> æ™¨é–“ä¾‹è¡Œ <span id="morningProgress" style="font-size: 0.8em; opacity: 0.8;"></span></h4>
                    <div id="morningRoutine"></div>
                </div>
                <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0232b 100%); color: white; padding: 20px; border-radius: 8px;">
                    <h4><i class="fas fa-moon"></i> æ™šé–“ä¾‹è¡Œ <span id="eveningProgress" style="font-size: 0.8em; opacity: 0.8;"></span></h4>
                    <div id="eveningRoutine"></div>
                </div>
            </div>

            <!-- CBT Practices -->
            <div class="mindfulness-section" id="cbtSection">
                <h3 style="color: white; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-spa"></i> CBTç„¦é»ç·´ç¿’å·¥å…·
                </h3>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: white; margin-bottom: 10px;"><i class="fas fa-wind"></i> æ­£å¿µå‘¼å¸ç·´ç¿’</h4>
                    <p style="font-size: 0.95em; margin-bottom: 10px;">é»æ“Šåœ“åœˆé–‹å§‹å‘¼å¸ç·´ç¿’ï¼Œè·Ÿè‘—è„ˆè¡ç¯€å¥é™ä½ç„¦æ…®ã€‚</p>
                    <div id="breathCircle" class="breath-circle" onclick="startBreathPractice(); event.preventDefault(); return false;">
                        <span id="breathText">é»æ“Šé–‹å§‹</span>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: white; margin-bottom: 10px;"><i class="fas fa-brain"></i> èªçŸ¥é‡æ§‹ç·´ç¿’</h4>
                    <button class="btn" onclick="openThoughtRecord()" style="background: rgba(255,255,255,0.9); color: var(--dark); width: 100%;"><i class="fas fa-edit"></i> é–‹å§‹ç·´ç¿’</button>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                    <h4 style="color: white; margin-bottom: 10px;"><i class="fas fa-leaf"></i> 5-4-3-2-1æ¥åœ°æŠ€å·§</h4>
                    <button class="btn" onclick="startGrounding()" style="background: rgba(255,255,255,0.9); color: var(--dark); width: 100%;"><i class="fas fa-play"></i> é–‹å§‹æ¥åœ°</button>
                </div>
            </div>

            <!-- Modals -->
            <div id="thoughtRecordModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">èªçŸ¥é‡æ§‹ç·´ç¿’</h2>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">è² é¢æƒ³æ³•ï¼š</label>
                        <textarea id="negativThought" placeholder="ä¾‹å¦‚ï¼šæˆ‘æ°¸é ç„¡æ³•å®Œæˆé€™å€‹ä»»å‹™..." style="width: 100%; padding: 10px; border: 2px solid var(--light); border-radius: 6px; font-family: inherit; font-size: 1em;" rows="3"></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">è­‰æ“šæ”¯æŒé€™å€‹æƒ³æ³•ï¼š</label>
                        <textarea id="evidence" placeholder="åˆ—èˆ‰äº‹å¯¦è­‰æ“š..." style="width: 100%; padding: 10px; border: 2px solid var(--light); border-radius: 6px; font-family: inherit; font-size: 1em;" rows="3"></textarea>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 5px;">æ›´ç¾å¯¦çš„æƒ³æ³•ï¼š</label>
                        <textarea id="realisticThought" placeholder="ä¾‹å¦‚ï¼šæˆ‘å¯ä»¥åˆ†å°æ­¥é©Ÿå®Œæˆ..." style="width: 100%; padding: 10px; border: 2px solid var(--light); border-radius: 6px; font-family: inherit; font-size: 1em;" rows="3"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="saveThoughtRecord()" style="flex: 1;"><i class="fas fa-check"></i> ç·´ç¿’å®Œæˆ</button>
                        <button class="btn" onclick="closeThoughtRecord()" style="flex: 1; background: #999;"><i class="fas fa-times"></i> é—œé–‰</button>
                    </div>
                </div>
            </div>

            <div id="groundingModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; text-align: center;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">5-4-3-2-1 æ¥åœ°æŠ€å·§</h2>
                    <div id="groundingSteps" style="margin: 20px 0;"></div>
                    <button class="btn" onclick="closeGrounding()" style="width: 100%;"><i class="fas fa-times"></i> å®Œæˆç·´ç¿’</button>
                </div>
            </div>

            <!-- Task Decomposition & Management -->
            <h3 id="taskSection"><i class="fas fa-tasks"></i> æ™ºèƒ½ä»»å‹™ç®¡ç†</h3>
            <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">å°‡å¤§ä»»å‹™è‡ªå‹•åˆ†è§£ï¼Œæˆ–æ‰‹å‹•æ·»åŠ å°æ­¥é©Ÿ</p>
            
            <div class="input-group">
                <input type="text" id="newTask" placeholder="ä¾‹å¦‚ï¼šç·¨è¼¯å½±ç‰‡ç‰‡æ®µ..." onkeypress="if(event.key==='Enter') addTask()">
                <button class="btn btn-success" onclick="addTask()"><i class="fas fa-plus"></i> æ–°å¢</button>
                <button class="btn" onclick="openTaskDecompose()" title="è‡ªå‹•åˆ†è§£ä»»å‹™"><i class="fas fa-sitemap"></i> åˆ†è§£</button>
            </div>

            <!-- Task Decompose Modal -->
            <div id="decomposeModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="color: var(--primary); margin-bottom: 20px;">ä»»å‹™åˆ†è§£è¨­å®š</h2>
                    <p style="color: #666; margin-bottom: 15px;">ç·¨è¼¯æ¯å€‹æ­¥é©Ÿçš„å…§å®¹ï¼š</p>
                    <div id="decomposeStepsContainer"></div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="confirmTaskDecompose()" style="flex: 1;"><i class="fas fa-check"></i> ç¢ºèªåˆ†è§£</button>
                        <button class="btn" onclick="closeTaskDecompose()" style="flex: 1; background: #999;"><i class="fas fa-times"></i> é—œé–‰</button>
                    </div>
                </div>
            </div>

            <ul class="task-list" id="tasks"></ul>

            <div class="progress-summary" id="progressSummary">
                <div style="font-size: 0.9em; color: #666;">é€²åº¦</div>
                <div class="percentage" id="percentage">0%</div>
                <div id="progressText" style="color: #666; font-size: 0.9em; margin-top: 5px;"></div>
            </div>

            <!-- Pomodoro Timer -->
            <h3 id="timerSection"><i class="fas fa-hourglass-start"></i> ç•ªèŒ„ç„¦é»è¨ˆæ™‚</h3>
            <div style="display: flex; align-items: center; gap: 15px; margin: 20px 0; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap;">
                <label style="font-weight: 500; color: var(--dark); min-width: 100px;">è¨ˆæ™‚åˆ†é˜æ•¸ï¼š</label>
                <input type="range" id="timerMinutes" min="1" max="60" value="25" step="1" style="flex: 1; cursor: pointer; height: 8px; border-radius: 5px; background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71); min-width: 100px;">
                <span id="timerMinutesDisplay" style="min-width: 50px; text-align: center; font-weight: bold; color: var(--primary); font-size: 1.2em;">25</span>
                <span style="color: #666;">åˆ†é˜</span>
            </div>

            <!-- Timer Sound Settings -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4 style="margin-bottom: 15px;"><i class="fas fa-volume-up"></i> è¨ˆæ™‚å™¨é¬§é˜è¨­å®š</h4>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <label style="font-weight: 500;">é¬§é˜é–‹é—œï¼š</label>
                    <button class="btn btn-small" id="timerSoundToggle" onclick="toggleTimerSound()" style="margin: 0;">
                        <i class="fas fa-volume-up"></i> <span id="timerSoundStatus">é–‹å•Ÿ</span>
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <label style="font-weight: 500; min-width: 80px;">éŸ³é‡èª¿æ•´ï¼š</label>
                    <input type="range" id="timerVolume" min="0" max="100" value="50" style="flex: 1; cursor: pointer; min-width: 100px;">
                    <span id="timerVolumeDisplay" style="min-width: 50px; text-align: center; font-weight: bold; color: var(--primary);">50%</span>
                </div>
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
                    <label style="font-weight: 500; min-width: 80px;">é¬§éˆ´è²éŸ³ï¼š</label>
                    <select id="timerSoundType" style="flex: 1; padding: 8px; border: 2px solid var(--light); border-radius: 6px; min-width: 150px;">
                        <option value="bell">æ¸…è„†éˆ´è² ğŸ””</option>
                        <option value="chime">æ‚…è€³éŸ³è‰² âœ¨</option>
                        <option value="alert">è­¦å‘Šè² âš ï¸</option>
                        <option value="digital">ç§‘æŠ€æ„Ÿ ğŸ¤–</option>
                    </select>
                    <button class="btn btn-small" onclick="testTimerSound()" style="margin: 0;"><i class="fas fa-play"></i> æ¸¬è©¦</button>
                </div>
            </div>
            
            <div class="timer-display">
                <div id="timer">25:00</div>
                <div id="progress"><div class="bar" id="progressBar"><span id="timerPercent">0%</span></div></div>
                
                <button class="btn btn-success" id="startTimer" onclick="startTimer()"><i class="fas fa-play"></i> é–‹å§‹è¨ˆæ™‚</button>
                <button class="btn btn-danger hidden" id="stopTimer" onclick="stopTimer()"><i class="fas fa-stop"></i> åœæ­¢</button>
                
                <div id="timerMessage"></div>
            </div>

            <!-- Emotion Tracking -->
            <h3 id="emotionSection"><i class="fas fa-heart"></i> æƒ…ç·’è¿½è¹¤æ—¥èªŒ</h3>
            <div style="display: flex; gap: 10px; margin: 10px 0; justify-content: space-around; flex-wrap: wrap;">
                <button class="btn btn-small" onclick="logEmotion('ğŸ˜„', 'é«˜èˆˆ'); event.preventDefault(); return false;"><span style="font-size: 1.5em;">ğŸ˜„</span> é«˜èˆˆ</button>
                <button class="btn btn-small" onclick="logEmotion('ğŸ˜', 'å¹³éœ'); event.preventDefault(); return false;"><span style="font-size: 1.5em;">ğŸ˜</span> å¹³éœ</button>
                <button class="btn btn-small" onclick="logEmotion('ğŸ˜', 'æ²®å–ª'); event.preventDefault(); return false;"><span style="font-size: 1.5em;">ğŸ˜</span> æ²®å–ª</button>
                <button class="btn btn-small" onclick="logEmotion('ğŸ˜°', 'ç„¦æ…®'); event.preventDefault(); return false;"><span style="font-size: 1.5em;">ğŸ˜°</span> ç„¦æ…®</button>
            </div>
            <div id="emotionLog"></div>

            <!-- Daily Streak -->
            <h3 id="streakSection"><i class="fas fa-fire"></i> é€£çºŒæ‰“å¡</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value" id="streak">0</div>
                    <div class="label">å¤©é€£çºŒä½¿ç”¨</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="totalMinutes">0</div>
                    <div class="label">å°ˆæ³¨åˆ†é˜</div>
                </div>
            </div>

            <!-- Quiz History -->
            <h3 id="historySection"><i class="fas fa-history"></i> æ¸¬é©—æ­·å²è¨˜éŒ„</h3>
            <div id="quizHistory" style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 300px; overflow-y: auto;"></div>

            <!-- Email Report Section -->
            <h3 id="emailSection"><i class="fas fa-envelope"></i> å‚³é€å ±å‘Šåˆ°Email</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">
                <p style="color: #333; margin-bottom: 15px;">å°‡æ‚¨çš„é€²åº¦å ±å‘Šç™¼é€åˆ°é›»å­éƒµä»¶ï¼Œä»¥ä¾¿å‚™ä»½å’Œè¿½è¹¤ã€‚</p>
                <div class="input-group">
                    <input type="email" id="userEmail" placeholder="example@email.com" style="flex: 1;">
                    <button class="btn btn-success" onclick="sendReportToEmail(); event.preventDefault(); return false;" style="margin: 0;"><i class="fas fa-paper-plane"></i> ç™¼é€å ±å‘Š</button>
                </div>
                <div id="emailStatus" style="margin-top: 10px; color: #666; font-size: 0.9em;"></div>
                <div class="info-text">
                    <i class="fas fa-info-circle"></i> <strong>é‡è¦æç¤ºï¼š</strong>ç•¶å‰æ‰€æœ‰ç´€éŒ„åªæœƒå„²å­˜åœ¨æ­¤è£ç½®ã€‚å¦‚éœ€åœ¨é›»å­éƒµä»¶ä¿å­˜å ±å‘Šå‰¯æœ¬ï¼Œè«‹è¼¸å…¥æ‚¨çš„éƒµä»¶åœ°å€ä¸¦ç™¼é€å ±å‘Šã€‚ç³»çµ±æœƒè‡ªå‹•é–‹å•Ÿæ‚¨çš„éƒµä»¶æ‡‰ç”¨ç¨‹å¼ï¼Œæ‚¨å¯ä»¥æ‰‹å‹•ç™¼é€æˆ–å°‡å ±å‘Šè¤‡è£½åˆ°å‰ªè²¼æ¿ã€‚
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Scroll -->
    <div class="nav-scroll">
        <button class="nav-scroll-btn" onclick="scrollToSection('energySection')">
            <i class="fas fa-battery-three-quarters"></i>
            <span class="nav-scroll-label">ç²¾åŠ›æª¢æ¸¬</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('routineSection')">
            <i class="fas fa-calendar-check"></i>
            <span class="nav-scroll-label">ä¾‹è¡Œç¨‹åº</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('cbtSection')">
            <i class="fas fa-spa"></i>
            <span class="nav-scroll-label">å¿ƒç†å·¥å…·</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('taskSection')">
            <i class="fas fa-tasks"></i>
            <span class="nav-scroll-label">ä»»å‹™ç®¡ç†</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('timerSection')">
            <i class="fas fa-hourglass-start"></i>
            <span class="nav-scroll-label">è¨ˆæ™‚å™¨</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('emotionSection')">
            <i class="fas fa-heart"></i>
            <span class="nav-scroll-label">æƒ…ç·’è¿½è¹¤</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('streakSection')">
            <i class="fas fa-fire"></i>
            <span class="nav-scroll-label">é€£çºŒæ‰“å¡</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('historySection')">
            <i class="fas fa-history"></i>
            <span class="nav-scroll-label">æ­·å²è¨˜éŒ„</span>
        </button>
        <button class="nav-scroll-btn" onclick="scrollToSection('emailSection')">
            <i class="fas fa-envelope"></i>
            <span class="nav-scroll-label">ç™¼é€å ±å‘Š</span>
        </button>
    </div>

    <script>
        const questions = [
            'æˆ‘ç¶“å¸¸æ‹–å»¶ä»»å‹™ç›´åˆ°æœ€å¾Œä¸€åˆ»ã€‚',
            'æˆ‘é›£ä»¥ç¶­æŒæ³¨æ„åŠ›åœ¨ç„¡è¶£å·¥ä½œä¸Šã€‚',
            'æˆ‘å®¹æ˜“åˆ†å¿ƒæ–¼ç„¡é—œäº‹ç‰©ã€‚',
            'æˆ‘å®¹æ˜“å¿˜è¨˜å›è¦†è¨Šæ¯ã€æ”¯ä»˜å¸³å–®æˆ–å®Œæˆé å®šä»»å‹™ã€‚',
            'æˆ‘è¡å‹•è¡Œäº‹è€Œä¸è€ƒæ…®å¾Œæœã€‚',
            'æˆ‘å®¹æ˜“æ„Ÿåˆ°ä¸è€ç…©æˆ–æŒ«æŠ˜ã€‚',
            'æˆ‘é›£ä»¥éµå¾ªæŒ‡ç¤ºæˆ–å®Œæˆå¤šæ­¥é©Ÿä»»å‹™ã€‚',
            'æˆ‘ç¶“å¸¸ä¸­æ–·ä»–äººæˆ–è¡å‹•èªªè©±ã€‚',
            'æˆ‘çš„æƒ…ç·’è®ŠåŒ–å¾ˆå¿«ã€‚',
            'æˆ‘é›£ä»¥çµ„ç¹”æ±è¥¿æˆ–ç®¡ç†æ™‚é–“ã€‚'
        ];

        let score = 0;
        let answers = [];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let stats = JSON.parse(localStorage.getItem('stats')) || { streak: 0, totalSessions: 0, totalMinutes: 0, lastDate: null, level: 1, xp: 0 };
        let quizHistory = JSON.parse(localStorage.getItem('quizHistory')) || [];
        let emotionHistory = JSON.parse(localStorage.getItem('emotionHistory')) || [];
        let routineCompletedToday = JSON.parse(localStorage.getItem('routineCompletedToday')) || { morning: false, evening: false, date: new Date().toDateString() };
        let currentEnergy = 3;
        let timerInterval;
        let timerDuration = 25 * 60;
        let timeLeft = 25 * 60;
        let isRunning = false;
        let isBreathing = false;
        let hasCompletedQuiz = localStorage.getItem('hasCompletedQuiz') === 'true';
        let timerSoundEnabled = localStorage.getItem('timerSoundEnabled') !== 'false';
        let timerVolume = parseInt(localStorage.getItem('timerVolume')) || 50;
        let timerSoundType = localStorage.getItem('timerSoundType') || 'bell';

        let audioContext;

        function startQuiz() {
            const qDiv = document.getElementById('questions');
            qDiv.innerHTML = '';
            
            questions.forEach((q, i) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'question-group';
                
                const label = document.createElement('label');
                label.textContent = `${i + 1}. ${q}`;
                
                const sliderContainer = document.createElement('div');
                sliderContainer.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-top: 10px;';
                
                const sliderInput = document.createElement('input');
                sliderInput.type = 'range';
                sliderInput.id = `q${i}`;
                sliderInput.min = '1';
                sliderInput.max = '5';
                sliderInput.value = '3';
                sliderInput.style.cssText = 'flex: 1; cursor: pointer; height: 8px; border-radius: 5px; background: linear-gradient(to right, #e74c3c 0%, #f39c12 25%, #2ecc71 100%);';
                
                const valueDisplay = document.createElement('span');
                valueDisplay.id = `val${i}`;
                valueDisplay.textContent = '3';
                valueDisplay.style.cssText = 'min-width: 40px; text-align: center; font-weight: bold; color: var(--primary); font-size: 1.2em;';
                
                const labels = ['å¾ä¸', 'å°‘æœ‰', 'æœ‰æ™‚', 'ç¶“å¸¸', 'ç¸½æ˜¯'];
                const labelDisplay = document.createElement('span');
                labelDisplay.id = `label${i}`;
                labelDisplay.textContent = labels[2];
                labelDisplay.style.cssText = 'min-width: 60px; text-align: left; font-size: 0.9em; color: #666;';
                
                sliderInput.addEventListener('input', (e) => {
                    const val = e.target.value;
                    valueDisplay.textContent = val;
                    labelDisplay.textContent = labels[val - 1];
                });
                
                sliderContainer.appendChild(sliderInput);
                sliderContainer.appendChild(valueDisplay);
                sliderContainer.appendChild(labelDisplay);
                
                groupDiv.appendChild(label);
                groupDiv.appendChild(sliderContainer);
                qDiv.appendChild(groupDiv);
            });
            
            document.querySelector('#quiz .btn').style.display = 'none';
            document.getElementById('submitQuiz').classList.remove('hidden');
        }

        function retakeQuiz() {
            document.getElementById('quiz').classList.remove('hidden');
            document.getElementById('plan').classList.add('hidden');
            startQuiz();
        }

        function generatePlan() {
            answers = [];
            let allAnswered = true;
            
            for (let i = 0; i < 10; i++) {
                const slider = document.getElementById(`q${i}`);
                if (!slider) {
                    allAnswered = false;
                    break;
                }
                const value = parseInt(slider.value) || 3;
                answers.push(value);
            }
            
            if (!allAnswered || answers.length !== 10) {
                alert('è«‹å…ˆå›ç­”æ‰€æœ‰10å€‹å•é¡Œï¼');
                return;
            }
            
            score = answers.reduce((a, b) => a + b, 0);

            const testRecord = {
                date: new Date().toLocaleString('zh-TW'),
                score: score
            };
            quizHistory.push(testRecord);
            localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
            localStorage.setItem('hasCompletedQuiz', 'true');
            hasCompletedQuiz = true;

            document.getElementById('quiz').classList.add('hidden');
            document.getElementById('plan').classList.remove('hidden');

            let level, advice;
            if (score < 15) {
                level = 'è¼•å¾®å‚¾å‘';
                advice = 'å¾ˆå¥½ï¼ä½ çš„ADHDå‚¾å‘è¼•å¾®ã€‚é€éæ—¥å¸¸ç¿’æ…£å„ªåŒ–ï¼Œå°ˆæ³¨åŠ›å¯å¿«é€Ÿæ”¹å–„ã€‚';
            } else if (score < 25) {
                level = 'ä¸­ç­‰å‚¾å‘';
                advice = 'ä¸­ç­‰ç¨‹åº¦ADHDç—‡ç‹€ã€‚çµåˆé‹å‹•ã€å†¥æƒ³èˆ‡çµæ§‹åŒ–è¨ˆåŠƒï¼Œ6é€±å…§å¯è¦‹é¡¯è‘—é€²å±•ã€‚';
            } else if (score < 35) {
                level = 'è¼ƒæ˜é¡¯å‚¾å‘';
                advice = 'è¼ƒæ˜é¡¯ADHDç—‡ç‹€ã€‚å»ºè­°åŒæ™‚é€²è¡Œæœ¬è¨ˆåŠƒèˆ‡å°ˆæ¥­è©•ä¼°ï¼ˆèº«å¿ƒç§‘/ç²¾ç¥ç§‘ï¼‰ã€‚';
            } else {
                level = 'åš´é‡å‚¾å‘';
                advice = 'ç—‡ç‹€è¼ƒåš´é‡ï¼Œè«‹å„ªå…ˆå°‹æ±‚å°ˆæ¥­é†«ç™‚è©•ä¼°ã€‚æ­¤å·¥å…·å¯ä½œç‚ºè¼”åŠ©ã€‚';
            }

            document.getElementById('score').textContent = score + '/50';
            document.getElementById('level').textContent = level;

            const tips = [
                'åˆ†è§£ä»»å‹™æˆ5-10åˆ†é˜å°æ­¥é©Ÿï¼Œé¿å…éè¼‰ã€‚',
                'æ¯æ—¥ç·´ç¿’æ­£å¿µå‘¼å¸ï¼šå¸4ç§’ã€æ†‹4ç§’ã€å4ç§’ï¼Œé‡è¤‡5æ¬¡ã€‚',
                'è¨­å®šç’°å¢ƒï¼šç§»é™¤æ‰‹æ©Ÿé€šçŸ¥ï¼Œå°ˆæ³¨ç•¶å‰ä»»å‹™ã€‚',
                'æ…¶ç¥å°å‹åˆ©ï¼šå®Œæˆä»»å‹™å¾Œè¨˜éŒ„æˆå°±ã€‚',
                'çµåˆé‹å‹•ï¼šè¨ˆæ™‚å¾Œæ•£æ­¥5åˆ†é˜ã€‚',
                'ç¢ºä¿æ¯æ™š8å°æ™‚é€£çºŒç¡çœ ï¼Œè¦å¾‹ä¸‰é¤ã€‚',
                'æ¯é€±é‹å‹•3-5æ¬¡ï¼Œä¸­ç­‰å¼·åº¦æœ‰æ°§é‹å‹•æœ€æœ‰æ•ˆã€‚'
            ];

            const tipCount = Math.min(5, Math.ceil(score / 10));
            const selectedTips = tips.slice(0, tipCount);
            document.getElementById('dailyTips').innerHTML = 
                `<div class="success-message"><i class="fas fa-info-circle"></i> ${advice}</div>` +
                selectedTips.map(t => 
                    `<div class="tip"><i class="fas fa-star"></i> <div>${t}</div></div>`
                ).join('');

            updateStats();
            renderQuizHistory();
            renderEnergyLevel();
            renderRoutines();
            loadTasks();
            updateProgress();
        }

        function renderEnergyLevel() {
            const energyDiv = document.getElementById('energyLevel');
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<div class="energy-bar ${i <= currentEnergy ? 'active' : ''}" onclick="setEnergy(${i})" title="é»æ“Šè¨­å®šç²¾åŠ›æ°´å¹³"></div>`;
            }
            energyDiv.innerHTML = html;

            const recommendations = {
                1: 'ğŸ”´ ä½èƒ½é‡ â†’ ç°¡å–®ä»»å‹™ï¼šæª¢æŸ¥éƒµä»¶ã€æ•´ç†æ¡Œå­ã€å–æ°´ä¼‘æ¯',
                2: 'ğŸŸ  ç•¥ä½èƒ½é‡ â†’ ä¸­ç­‰ä»»å‹™ï¼šå›è¦†è¨Šæ¯ã€æ•´ç†æ–‡ä»¶ã€ç°¡å–®ç·¨è¼¯',
                3: 'ğŸŸ¡ ä¸­ç­‰èƒ½é‡ â†’ å¸¸è¦ä»»å‹™ï¼šå¤§å¤šæ•¸å·¥ä½œã€éŒ„éŸ³ã€å…§å®¹ç­–åŠƒ',
                4: 'ğŸŸ¢ é«˜èƒ½é‡ â†’ å›°é›£ä»»å‹™ï¼šå‰µæ„é …ç›®ã€è¤‡é›œç·¨è¼¯ã€é‡è¦æœƒè­°',
                5: 'ğŸŸ¢ è¶…é«˜èƒ½é‡ â†’ æŒ‘æˆ°ä»»å‹™ï¼šå…¨å¤©æ‹æ”ã€è¤‡é›œè£½ä½œã€å‰µæ„çªç ´'
            };
            
            const energyTasks = {
                1: ['âœ… å–ä¸€æ¯å’–å•¡æˆ–èŒ¶', 'âœ… åš5åˆ†é˜ä¼¸å±•é‹å‹•', 'âœ… è½å–œæ­¡çš„æ­Œæ›²'],
                2: ['âœ… æ•£æ­¥5åˆ†é˜', 'âœ… åšç°¡å–®çš„æ–‡æ›¸å·¥ä½œ', 'âœ… å›è¦†ç°¡çŸ­è¨Šæ¯'],
                3: ['âœ… å®Œæˆæ—¥å¸¸å·¥ä½œ', 'âœ… é€²è¡Œä¸­ç­‰è¤‡é›œåº¦ä»»å‹™', 'âœ… åƒåŠ æœƒè­°'],
                4: ['âœ… é–‹å§‹å‰µæ„é …ç›®', 'âœ… é€²è¡Œæ·±åº¦å·¥ä½œ', 'âœ… å­¸ç¿’æ–°æŠ€èƒ½'],
                5: ['âœ… å•Ÿå‹•é‡å¤§é …ç›®', 'âœ… è§£æ±ºè¤‡é›œå•é¡Œ', 'âœ… é€²è¡Œé•·æ™‚é–“è£½ä½œ']
            };

            const recommendation = recommendations[currentEnergy];
            const suggestedTasks = energyTasks[currentEnergy].join(' | ');
            document.getElementById('taskRecommendation').innerHTML = `
                <div style="margin-bottom: 10px;"><strong>${recommendation}</strong></div>
                <div style="font-size: 0.9em; color: #666;">${suggestedTasks}</div>
            `;
        }

        function setEnergy(level) {
            currentEnergy = level;
            localStorage.setItem('currentEnergy', level);
            renderEnergyLevel();
            addXP(10, 'âš¡ è¨­å®šç²¾åŠ›æ°´å¹³');
        }

        function renderRoutines() {
            const morning = [
                { text: 'èµ·åºŠ', icon: 'â°', hint: 'è¨­å®šä¸‰å€‹é¬§é˜' },
                { text: 'æ­£å¿µå‘¼å¸', icon: 'ğŸ§˜', hint: '' },
                { text: 'æ´—æ¾¡å’Œæ¢³æ´—', icon: 'ğŸš¿', hint: '' },
                { text: 'å¥åº·æ—©é¤', icon: 'ğŸ½ï¸', hint: '' },
                { text: 'æª¢æŸ¥å„ªå…ˆä»»å‹™', icon: 'ğŸ“', hint: '' }
            ];

            const evening = [
                { text: 'æ”¾ä¸‹æ‰‹æ©Ÿ', icon: 'ğŸ“±', hint: '' },
                { text: 'æ”¾é¬†å‘¼å¸', icon: 'ğŸ§˜', hint: '' },
                { text: 'å¯«ä¸‹æ˜å¤©è¨ˆåŠƒ', icon: 'ğŸ“”', hint: '' },
                { text: 'æº–å‚™ç¡çœ ç’°å¢ƒ', icon: 'ğŸ›ï¸', hint: '' },
                { text: 'æŒ‰æ™‚ç¡çœ ', icon: 'ğŸ˜´', hint: '' }
            ];

            const today = new Date().toDateString();
            if (routineCompletedToday.date !== today) {
                routineCompletedToday = { morning: false, evening: false, steps: {}, date: today };
            }

            let morningCompleted = 0;
            document.getElementById('morningRoutine').innerHTML = morning.map((r, i) => {
                const stepKey = `morning_${i}`;
                const isCompleted = routineCompletedToday.steps && routineCompletedToday.steps[stepKey];
                if (isCompleted) morningCompleted++;
                return `
                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,${isCompleted ? '0.3' : '0.1'}); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; opacity: ${isCompleted ? '0.7' : '1'};">
                    <div>
                        <div style="font-weight: bold; ${isCompleted ? 'text-decoration: line-through;' : ''}">${r.icon} ${r.text}</div>
                        ${r.hint ? `<div style="font-size: 0.85em; opacity: 0.8;">${r.hint}</div>` : ''}
                    </div>
                    <button class="btn btn-small" onclick="completeRoutineStep('morning', ${i})" style="background: rgba(255,255,255,0.9); color: var(--dark); margin: 0;"><i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-circle'}"></i></button>
                </div>
            `}).join('');
            document.getElementById('morningProgress').textContent = `(${morningCompleted}/${morning.length})`;

            let eveningCompleted = 0;
            document.getElementById('eveningRoutine').innerHTML = evening.map((r, i) => {
                const stepKey = `evening_${i}`;
                const isCompleted = routineCompletedToday.steps && routineCompletedToday.steps[stepKey];
                if (isCompleted) eveningCompleted++;
                return `
                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,${isCompleted ? '0.3' : '0.1'}); border-radius: 4px; display: flex; justify-content: space-between; align-items: center; opacity: ${isCompleted ? '0.7' : '1'};">
                    <div>
                        <div style="font-weight: bold; ${isCompleted ? 'text-decoration: line-through;' : ''}">${r.icon} ${r.text}</div>
                        ${r.hint ? `<div style="font-size: 0.85em; opacity: 0.8;">${r.hint}</div>` : ''}
                    </div>
                    <button class="btn btn-small" onclick="completeRoutineStep('evening', ${i})" style="background: rgba(255,255,255,0.9); color: var(--dark); margin: 0;"><i class="fas ${isCompleted ? 'fa-check-circle' : 'fa-circle'}"></i></button>
                </div>
            `}).join('');
            document.getElementById('eveningProgress').textContent = `(${eveningCompleted}/${evening.length})`;
        }

        function completeRoutineStep(type, index) {
            const today = new Date().toDateString();
            if (routineCompletedToday.date !== today) {
                routineCompletedToday = { morning: false, evening: false, steps: {}, date: today };
            }

            const stepKey = `${type}_${index}`;
            if (!routineCompletedToday.steps) {
                routineCompletedToday.steps = {};
            }

            if (!routineCompletedToday.steps[stepKey]) {
                routineCompletedToday.steps[stepKey] = true;
                addXP(5, 'âœ… å®Œæˆä¾‹è¡Œæ­¥é©Ÿ');
            } else {
                routineCompletedToday.steps[stepKey] = false;
            }

            renderRoutines();
            localStorage.setItem('routineCompletedToday', JSON.stringify(routineCompletedToday));
        }

        function addTask() {
            const input = document.getElementById('newTask');
            if (input.value.trim()) {
                tasks.push({ text: input.value, completed: false, date: new Date().toDateString() });
                input.value = '';
                saveTasks();
                renderTasks();
                updateProgress();
            }
        }

        function deleteTask(index) {
            tasks.splice(index, 1);
            saveTasks();
            renderTasks();
            updateProgress();
        }

        function toggleTask(index) {
            tasks[index].completed = !tasks[index].completed;
            saveTasks();
            renderTasks();
            updateProgress();
            if (tasks[index].completed) {
                addXP(50, 'âœ… å®Œæˆä»»å‹™');
                showLevelUpAnimation();
            }
        }

        function renderTasks() {
            const ul = document.getElementById('tasks');
            if (tasks.length === 0) {
                ul.innerHTML = '<li style="text-align: center; color: #999; border: none;">é‚„æœªæ–°å¢ä»»å‹™ï¼Œé–‹å§‹åŠ å…¥ç¬¬ä¸€å€‹å§ï¼</li>';
                return;
            }
            ul.innerHTML = tasks.map((task, i) => 
                `<li class="task-item ${task.completed ? 'completed' : ''}">
                    <span><i class="fas ${task.completed ? 'fa-check-circle' : 'fa-circle'}"></i> ${task.text}</span>
                    <div class="task-actions">
                        <button class="btn btn-small ${task.completed ? 'btn-danger' : 'btn-success'}" onclick="toggleTask(${i})">
                            ${task.completed ? 'å–æ¶ˆ' : 'å®Œæˆ'}
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteTask(${i})"><i class="fas fa-trash"></i></button>
                    </div>
                </li>`
            ).join('');
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function loadTasks() {
            renderTasks();
        }

        function updateProgress() {
            const completed = tasks.filter(t => t.completed).length;
            const total = tasks.length || 1;
            const percentage = Math.round(completed / total * 100);
            
            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} / ${total} ä»»å‹™å®Œæˆ`;
        }

        function openTaskDecompose() {
            const taskInput = document.getElementById('newTask').value;
            if (!taskInput) {
                alert('è«‹å…ˆè¼¸å…¥ä¸€å€‹ä»»å‹™ï¼');
                return;
            }

            const defaultSteps = [
                `${taskInput} - ç¬¬1æ­¥ï¼šæº–å‚™å·¥ä½œ`,
                `${taskInput} - ç¬¬2æ­¥ï¼šä¸»è¦å…§å®¹`,
                `${taskInput} - ç¬¬3æ­¥ï¼šæª¢æŸ¥å’Œèª¿æ•´`,
                `${taskInput} - ç¬¬4æ­¥ï¼šå®Œæˆå’Œä¿å­˜`
            ];

            const container = document.getElementById('decomposeStepsContainer');
            container.innerHTML = defaultSteps.map((step, i) => `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 500; margin-bottom: 5px;">æ­¥é©Ÿ ${i + 1}ï¼š</label>
                    <input type="text" id="decompose_step_${i}" value="${step}" style="width: 100%; padding: 10px; border: 2px solid var(--light); border-radius: 6px; font-size: 1em;" />
                </div>
            `).join('');

            window.decomposeSteps = defaultSteps;
            document.getElementById('decomposeModal').style.display = 'flex';
        }

        function confirmTaskDecompose() {
            const steps = [];
            for (let i = 0; i < 4; i++) {
                const input = document.getElementById(`decompose_step_${i}`);
                if (input) {
                    steps.push(input.value || window.decomposeSteps[i]);
                }
            }

            steps.forEach(step => {
                tasks.push({ text: step, completed: false, date: new Date().toDateString() });
            });

            saveTasks();
            renderTasks();
            updateProgress();
            document.getElementById('newTask').value = '';
            closeTaskDecompose();
            alert('âœ… ä»»å‹™å·²åˆ†è§£ç‚º4å€‹å°æ­¥é©Ÿï¼');
        }

        function closeTaskDecompose() {
            document.getElementById('decomposeModal').style.display = 'none';
        }

        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                document.getElementById('startTimer').classList.add('hidden');
                document.getElementById('stopTimer').classList.remove('hidden');
                timerInterval = setInterval(updateTimer, 1000);
            }
        }

        function stopTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startTimer').classList.remove('hidden');
            document.getElementById('stopTimer').classList.add('hidden');
            timeLeft = timerDuration;
            updateTimerDisplay();
            document.getElementById('timerMessage').innerHTML = '';
        }

        function updateTimer() {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                isRunning = false;
                document.getElementById('startTimer').classList.remove('hidden');
                document.getElementById('stopTimer').classList.add('hidden');
                
                stats.totalSessions++;
                stats.totalMinutes += Math.floor(timerDuration / 60);
                updateStats();

                if (timerSoundEnabled) {
                    playSound(timerSoundType, timerVolume);
                }

                const mins = Math.floor(timerDuration / 60);
                document.getElementById('timerMessage').innerHTML = 
                    `<div class="success-message"><i class="fas fa-check-circle"></i> ${mins}åˆ†é˜è¨ˆæ™‚å®Œæˆï¼åšå¾—å¾ˆå¥½ï¼</div>`;
                
                timeLeft = timerDuration;
                updateTimerDisplay();
            }
        }

        function updateTimerDisplay() {
            const min = Math.floor(timeLeft / 60);
            const sec = timeLeft % 60;
            document.getElementById('timer').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
            
            const percentComplete = Math.round(((timerDuration - timeLeft) / timerDuration) * 100);
            document.getElementById('progressBar').style.width = percentComplete + '%';
            document.getElementById('timerPercent').textContent = percentComplete + '%';
        }

        function startBreathPractice() {
            if (!isBreathing) {
                isBreathing = true;
                const breathCircle = document.getElementById('breathCircle');
                const breathText = document.getElementById('breathText');
                
                breathCircle.classList.add('breathing');
                
                let cycleCount = 0;
                const maxCycles = 2;
                
                const phases = [
                    { text: 'å¸æ°£...', duration: 4 },
                    { text: 'å±ä½...', duration: 4 },
                    { text: 'åæ°£...', duration: 4 },
                    { text: 'æš«åœ...', duration: 4 }
                ];
                
                let currentPhase = 0;
                
                const updatePhase = () => {
                    if (cycleCount >= maxCycles) {
                        breathText.textContent = 'ç·´ç¿’å®Œæˆï¼âœ…';
                        breathCircle.classList.remove('breathing');
                        isBreathing = false;
                        addXP(25, 'ğŸ§˜ å®Œæˆå‘¼å¸ç·´ç¿’');
                        return;
                    }
                    
                    const phase = phases[currentPhase];
                    breathText.textContent = phase.text;
                    
                    currentPhase++;
                    if (currentPhase >= phases.length) {
                        currentPhase = 0;
                        cycleCount++;
                    }
                    
                    setTimeout(updatePhase, phase.duration * 1000);
                };
                
                updatePhase();
            }
        }

        function openThoughtRecord() {
            document.getElementById('thoughtRecordModal').style.display = 'flex';
        }

        function closeThoughtRecord() {
            document.getElementById('thoughtRecordModal').style.display = 'none';
        }

        function saveThoughtRecord() {
            const negative = document.getElementById('negativThought').value;
            const evidence = document.getElementById('evidence').value;
            const realistic = document.getElementById('realisticThought').value;
            
            if (!negative || !evidence || !realistic) {
                alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼');
                return;
            }

            alert('èªçŸ¥é‡æ§‹è¨˜éŒ„å·²ä¿å­˜ï¼');
            document.getElementById('negativThought').value = '';
            document.getElementById('evidence').value = '';
            document.getElementById('realisticThought').value = '';
            closeThoughtRecord();
            addXP(30, 'ğŸ§  å®ŒæˆèªçŸ¥é‡æ§‹');
        }

        function startGrounding() {
            document.getElementById('groundingModal').style.display = 'flex';
            const steps = [
                { title: 'çœ‹5æ¨£æ±è¥¿', icon: 'ğŸ‘€', instruction: 'å‘¨åœæœ‰ä»€éº¼ä½ èƒ½çœ‹åˆ°çš„ï¼Ÿ' },
                { title: 'è½4æ¨£è²éŸ³', icon: 'ğŸ‘‚', instruction: 'ä½ èƒ½è½åˆ°ä»€éº¼è²éŸ³ï¼Ÿ' },
                { title: 'è§¸æ‘¸3æ¨£ç‰©å“', icon: 'âœ‹', instruction: 'æ‘¸æ‘¸å‘¨åœçš„ç‰©å“ï¼Œæ„Ÿå—å®ƒå€‘çš„è³ªåœ°' },
                { title: 'è2æ¨£æ°£å‘³', icon: 'ğŸ‘ƒ', instruction: 'ä½ èƒ½èåˆ°ä»€éº¼æ°£å‘³ï¼Ÿ' },
                { title: 'åš1æ¨£å‘³é“', icon: 'ğŸ‘…', instruction: 'å–å£æ°´æˆ–åƒé»æ±è¥¿' }
            ];

            let currentStep = 0;
            const stepsDiv = document.getElementById('groundingSteps');
            
            function showStep() {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    stepsDiv.innerHTML = `
                        <div style="font-size: 3em; margin-bottom: 10px;">${step.icon}</div>
                        <h3 style="color: var(--primary); margin-bottom: 10px;">${step.title}</h3>
                        <p style="font-size: 1.1em; margin-bottom: 20px;">${step.instruction}</p>
                        <button class="btn btn-success" onclick="nextGroundingStep()" style="width: 100%;">ä¸‹ä¸€æ­¥</button>
                    `;
                    currentStep++;
                } else {
                    stepsDiv.innerHTML = `
                        <div style="font-size: 2em; margin-bottom: 20px;">âœ…</div>
                        <h3 style="color: var(--success);">æ¥åœ°å®Œæˆï¼</h3>
                        <p>ä½ ç¾åœ¨æ‡‰è©²æ„Ÿåˆ°æ›´åŠ æ”¾é¬†å’Œå°ˆæ³¨ã€‚</p>
                    `;
                    addXP(35, 'ğŸŒ¿ å®Œæˆæ¥åœ°æŠ€å·§');
                }
            }
            
            window.nextGroundingStep = showStep;
            showStep();
        }

        function closeGrounding() {
            document.getElementById('groundingModal').style.display = 'none';
        }

        function logEmotion(emoji, label) {
            const record = {
                time: new Date().toLocaleString('zh-TW'),
                emotion: label,
                emoji: emoji
            };
            emotionHistory.push(record);
            localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
            renderEmotionLog();
        }

        function renderEmotionLog() {
            const logDiv = document.getElementById('emotionLog');
            if (emotionHistory.length === 0) {
                logDiv.innerHTML = '<p style="color: #999;">å°šç„¡æƒ…ç·’è¨˜éŒ„</p>';
                return;
            }
            const recent = emotionHistory.slice(-5);
            logDiv.innerHTML = recent.map((record, idx) => {
                const actualIndex = emotionHistory.length - 5 + idx;
                return `<div class="emotion-log" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <span style="font-size: 1.5em; margin-right: 10px;">${record.emoji}</span>
                        <strong>${record.emotion}</strong> - ${record.time}
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn btn-small btn-danger" onclick="deleteEmotion(${actualIndex})" style="padding: 4px 8px; margin: 0;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
            addXP(15, 'ğŸ“Š è¨˜éŒ„æƒ…ç·’');
        }

        function deleteEmotion(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢æƒ…ç·’è¨˜éŒ„å—ï¼Ÿ')) {
                emotionHistory.splice(index, 1);
                localStorage.setItem('emotionHistory', JSON.stringify(emotionHistory));
                renderEmotionLog();
            }
        }

        function updateStats() {
            const today = new Date().toDateString();
            if (stats.lastDate !== today) {
                stats.streak = (stats.lastDate === new Date(Date.now() - 86400000).toDateString()) ? stats.streak + 1 : 1;
                stats.lastDate = today;
            }
            
            document.getElementById('streak').textContent = stats.streak;
            document.getElementById('totalMinutes').textContent = stats.totalMinutes;
            
            if (document.getElementById('levelDisplay')) {
                document.getElementById('levelDisplay').textContent = `Lv.${stats.level}`;
                document.getElementById('xpDisplay').textContent = `${stats.xp} XP`;
            }
            
            localStorage.setItem('stats', JSON.stringify(stats));
        }

        function addXP(amount, reason) {
            stats.xp += amount;
            const xpPerLevel = 500;
            
            while (stats.xp >= xpPerLevel) {
                stats.xp -= xpPerLevel;
                stats.level++;
                showLevelUpAnimation();
            }
            
            updateStats();
        }

        function showLevelUpAnimation() {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%);
                color: white;
                padding: 40px;
                border-radius: 15px;
                font-size: 2em;
                font-weight: bold;
                z-index: 10000;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;
            div.innerHTML = `ğŸ‰ å‡ç´šåˆ° Lv.${stats.level}ï¼`;
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 2000);
        }

        function renderQuizHistory() {
            const historyDiv = document.getElementById('quizHistory');
            if (quizHistory.length === 0) {
                historyDiv.innerHTML = '<p style="text-align: center; color: #999;">æš«ç„¡æ¸¬é©—è¨˜éŒ„</p>';
                return;
            }

            historyDiv.innerHTML = quizHistory.map((record, idx) => {
                let level = 'è¼•å¾®å‚¾å‘';
                if (record.score >= 15 && record.score < 25) level = 'ä¸­ç­‰å‚¾å‘';
                else if (record.score >= 25 && record.score < 35) level = 'è¼ƒæ˜é¡¯å‚¾å‘';
                else if (record.score >= 35) level = 'åš´é‡å‚¾å‘';

                return `
                    <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <strong>${record.date}</strong>
                            <div style="color: #666; font-size: 0.9em;">åˆ†æ•¸: ${record.score}/50 - ${level}</div>
                        </div>
                        <button class="btn btn-small btn-danger" onclick="deleteQuizRecord(${idx})" style="margin: 0;"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }).join('');
        }

        function deleteQuizRecord(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¸¬é©—è¨˜éŒ„å—ï¼Ÿ')) {
                quizHistory.splice(index, 1);
                localStorage.setItem('quizHistory', JSON.stringify(quizHistory));
                renderQuizHistory();
            }
        }

        function sendReportToEmail() {
            const userEmail = document.getElementById('userEmail').value.trim();
            const emailStatus = document.getElementById('emailStatus');
            
            if (!userEmail || !userEmail.includes('@')) {
                emailStatus.innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-times"></i> è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€</span>';
                return;
            }

            const completedTasks = tasks.filter(t => t.completed).length;
            const totalTasks = tasks.length;
            const taskProgress = totalTasks > 0 ? Math.round(completedTasks / totalTasks * 100) : 0;
            
            const report = {
                timestamp: new Date().toLocaleString('zh-TW'),
                email: userEmail,
                userStats: {
                    level: stats.level,
                    xp: stats.xp,
                    streak: stats.streak,
                    totalMinutes: stats.totalMinutes
                },
                tasks: {
                    completed: completedTasks,
                    total: totalTasks,
                    percentage: taskProgress,
                    list: tasks.map(t => ({ text: t.text, completed: t.completed }))
                },
                emotions: emotionHistory.slice(-10),
                quizHistory: quizHistory,
                currentEnergy: currentEnergy
            };

            const reportText = `ADHD Focus Helper Pro Max - é€²åº¦å ±å‘Š
==============================
ç”Ÿæˆæ™‚é–“: ${report.timestamp}
Email: ${userEmail}

ã€ä½¿ç”¨è€…çµ±è¨ˆã€‘
ç­‰ç´š: Lv.${report.userStats.level}
ç¶“é©—å€¼ (XP): ${report.userStats.xp}
é€£çºŒä½¿ç”¨å¤©æ•¸: ${report.userStats.streak}
å°ˆæ³¨ç¸½åˆ†é˜æ•¸: ${report.userStats.totalMinutes}

ã€ä»»å‹™é€²åº¦ã€‘
å®Œæˆ: ${report.tasks.completed}/${report.tasks.total} (${report.tasks.percentage}%)
${report.tasks.list.map(t => `- ${t.completed ? 'âœ…' : 'â­•'} ${t.text}`).join('\n')}

ã€æœ€è¿‘æƒ…ç·’è¨˜éŒ„ã€‘
${report.emotions.length > 0 ? report.emotions.map(e => `${e.emoji} ${e.emotion} (${e.time})`).join('\n') : 'æš«ç„¡è¨˜éŒ„'}

ã€æ¸¬é©—æ­·å²ã€‘
${report.quizHistory.length > 0 ? report.quizHistory.map(h => `${h.date} - åˆ†æ•¸: ${h.score}/50`).join('\n') : 'æš«ç„¡è¨˜éŒ„'}

ã€ç•¶å‰ç²¾åŠ›æ°´å¹³ã€‘
${['ğŸ”´ ä½', 'ğŸŸ  ç•¥ä½', 'ğŸŸ¡ ä¸­ç­‰', 'ğŸŸ¢ é«˜', 'ğŸŸ¢ è¶…é«˜'][report.currentEnergy - 1]} (${report.currentEnergy}/5)`;

            const subject = encodeURIComponent(`ADHD Focus Helper - é€²åº¦å ±å‘Š ${new Date().toLocaleDateString('zh-TW')}`);
            const body = encodeURIComponent(reportText);
            const mailtoLink = `mailto:${userEmail}?subject=${subject}&body=${body}`;
            
            navigator.clipboard.writeText(reportText).then(() => {
                emailStatus.innerHTML = '<span style="color: #2ecc71;"><i class="fas fa-check"></i> å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼æ­£åœ¨é–‹å•Ÿéƒµä»¶æ‡‰ç”¨ç¨‹å¼...</span>';
                
                setTimeout(() => {
                    window.location.href = mailtoLink;
                }, 800);
                
                setTimeout(() => {
                    emailStatus.innerHTML = '<span style="color: #2ecc71;"><i class="fas fa-check"></i> å ±å‘Šå·²ç”Ÿæˆï¼è«‹åœ¨éƒµä»¶ä¸­ç²˜è²¼æˆ–æ‰‹å‹•ç™¼é€ã€‚</span>';
                    document.getElementById('userEmail').value = '';
                }, 2000);
            }).catch(() => {
                emailStatus.innerHTML = '<span style="color: #f39c12;"><i class="fas fa-info-circle"></i> ç„¡æ³•è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹å…§å®¹</span>';
                alert(reportText);
                document.getElementById('userEmail').value = '';
            });
        }

        document.getElementById('timerMinutes')?.addEventListener('input', (e) => {
            const minutes = parseInt(e.target.value);
            document.getElementById('timerMinutesDisplay').textContent = minutes;
            timerDuration = minutes * 60;
            timeLeft = timerDuration;
            updateTimerDisplay();
        });

        function initializeApp() {
            currentEnergy = parseInt(localStorage.getItem('currentEnergy')) || 3;
            if (hasCompletedQuiz) {
                document.getElementById('quiz').classList.add('hidden');
                document.getElementById('plan').classList.remove('hidden');
                loadTasks();
                updateProgress();
                renderQuizHistory();
                renderEnergyLevel();
                renderRoutines();
                renderEmotionLog();
                updateStats();
            }
        }

        if (!stats.level) {
            stats.level = 1;
            stats.xp = 0;
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function playSound(type, volume) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const ctx = audioContext;
            const gainNode = ctx.createGain();
            gainNode.gain.value = volume / 100;
            gainNode.connect(ctx.destination);

            const duration = 0.5;
            const now = ctx.currentTime;

            if (type === 'bell') {
                const osc1 = ctx.createOscillator();
                const osc2 = ctx.createOscillator();
                osc1.frequency.value = 800;
                osc2.frequency.value = 600;
                osc1.connect(gainNode);
                osc2.connect(gainNode);
                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + duration);
                osc2.stop(now + duration);
            } else if (type === 'chime') {
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(400, now + duration);
                osc.connect(gainNode);
                osc.start(now);
                osc.stop(now + duration);
            } else if (type === 'alert') {
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(700, now);
                osc.frequency.setValueAtTime(900, now + duration / 2);
                osc.frequency.setValueAtTime(700, now + duration);
                osc.connect(gainNode);
                osc.start(now);
                osc.stop(now + duration);
            } else if (type === 'digital') {
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.setValueAtTime(1000, now + duration / 3);
                osc.frequency.setValueAtTime(1200, now + 2 * duration / 3);
                osc.connect(gainNode);
                osc.start(now);
                osc.stop(now + duration);
            }
        }

        function testTimerSound() {
            if (timerSoundEnabled) {
                playSound(timerSoundType, timerVolume);
            }
        }

        function toggleTimerSound() {
            timerSoundEnabled = !timerSoundEnabled;
            localStorage.setItem('timerSoundEnabled', timerSoundEnabled);
            const btn = document.getElementById('timerSoundToggle');
            const status = document.getElementById('timerSoundStatus');
            if (timerSoundEnabled) {
                btn.style.background = 'var(--success)';
                status.textContent = 'é–‹å•Ÿ';
            } else {
                btn.style.background = '#999';
                status.textContent = 'é—œé–‰';
            }
        }

        function initializeSoundSettings() {
            document.getElementById('timerVolume')?.addEventListener('input', (e) => {
                timerVolume = parseInt(e.target.value);
                document.getElementById('timerVolumeDisplay').textContent = timerVolume + '%';
                localStorage.setItem('timerVolume', timerVolume);
            });

            document.getElementById('timerSoundType')?.addEventListener('change', (e) => {
                timerSoundType = e.target.value;
                localStorage.setItem('timerSoundType', timerSoundType);
            });

            if (timerSoundEnabled) {
                document.getElementById('timerSoundToggle').style.background = 'var(--success)';
            } else {
                document.getElementById('timerSoundToggle').style.background = '#999';
            }
        }

        updateStats();
        initializeApp();
        initializeSoundSettings();
    </script>
</body>
</html>
